# Настройка прав доступа в Linux 22.04 для запуска приложений

Ниже приведён практический алгоритм, который помогает настроить права таким образом, чтобы сервис мог работать корректно, а пользователь оставался в пределах минимально необходимого доступа.

## 1. Создайте отдельного системного пользователя

```bash
sudo adduser --system --group --home /opt/myapp myapp
```

* `--system` создаёт пользователя без интерактивного входа и с UID ниже 1000.
* `--group` создаёт одноимённую группу, куда вы сможете добавлять администраторов.
* `--home` указывает каталог, где будут размещены файлы приложения.

## 2. Ограничьте владельца и группу каталога

```bash
sudo chown -R myapp:myapp /opt/myapp
sudo chmod -R o-rwx /opt/myapp
```

* Владелец и группа становятся `myapp`.
* Все остальные пользователи лишаются доступа по умолчанию.

Если администратору нужен доступ к каталогу, добавьте его в группу `myapp`:

```bash
sudo usermod -aG myapp adminuser
```

## 3. Используйте `setfacl` для тонкой настройки прав

Если необходимо дать доступ только к отдельным файлам/каталогам, используйте ACL:

```bash
sudo setfacl -m u:deploy:rX /opt/myapp
sudo setfacl -m u:deploy:rwX /opt/myapp/config
```

Это даёт пользователю `deploy` права только на чтение/выполнение всего каталога и право записи в `config`.

## 4. Минимизируйте sudo-права

Создайте файл в `/etc/sudoers.d/myapp` и добавьте минимальный набор команд:

```bash
myapp-deploy ALL=(myapp) NOPASSWD: /usr/bin/systemctl restart myapp.service
```

* Пользователь `myapp-deploy` может перезапускать сервис без полного доступа.
* Настройки проверяйте через `visudo -f /etc/sudoers.d/myapp`.

## 5. Запускайте сервисы через systemd с нужным пользователем

В файле юнита (`/etc/systemd/system/myapp.service`):

```ini
[Service]
User=myapp
Group=myapp
WorkingDirectory=/opt/myapp
ExecStart=/opt/myapp/bin/start.sh
ReadWritePaths=/opt/myapp/logs
ProtectSystem=strict
ProtectHome=true
```

Опции `ProtectSystem` и `ProtectHome` дополнительно изолируют процесс.

После изменения перезагрузите конфигурацию systemd:

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now myapp.service
```

## 6. Контролируйте разрешения на логи и временные файлы

* Используйте `tmpfiles.d` для автоматического создания каталогов логов и временных файлов.
* Убедитесь, что лог-файлы имеют владельца `myapp` и недоступны другим пользователям (`chmod 640`).

## 7. Проверяйте разрешения

Проверяйте, что лишние пользователи не имеют доступа:

```bash
namei -l /opt/myapp
sudo -u otheruser ls /opt/myapp
```

Скрипты и бинарные файлы должны иметь флаг `0750`, а конфигурации с чувствительными данными — `0640`.

## 8. Используйте контейнеризацию или AppArmor при необходимости

* Контейнеры (Docker/Podman) позволяют дополнительно изолировать приложение.
* AppArmor или SELinux обеспечивают мандатный контроль доступа поверх POSIX-прав.

## 9. Документируйте и автоматизируйте

* Опишите требуемые каталоги, владельцев и права в README или playbook Ansible.
* Автоматизируйте выдачу прав через CI/CD, чтобы избежать ручных ошибок.

Следуя этим шагам, вы обеспечите корректную работу кода и избежите излишнего доступа для пользователей.
